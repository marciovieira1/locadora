(function(n){var r,q=n.telerik,k=/\.([^\.]+)$/;q.upload=function(u,v){n.extend(this,v);this.element=u;this.name=u.name;var t=n(u);this.wrapper=t.closest(".t-upload");this._setActiveInput(t);this.toggle(this.enabled);t.closest("form").bind({submit:n.proxy(this._onParentFormSubmit,this),reset:n.proxy(this._onParentFormReset,this)});if(this.async.saveUrl!=r){this._module=this._getSupportsFormData()?new o(this):new f(this)}else{this._module=new g(this)}if(this._getSupportsDrop()){this._setupDropZone()}this.wrapper.delegate(".t-upload-action","click",n.proxy(this._onFileAction,this)).delegate(".t-upload-selected","click",n.proxy(this._onUploadSelected,this)).delegate(".t-file","t:progress",n.proxy(this._onFileProgress,this)).delegate(".t-file","t:upload-success",n.proxy(this._onUploadSuccess,this)).delegate(".t-file","t:upload-error",n.proxy(this._onUploadError,this));this.wrapper.bind("t:uploads-complete",n.proxy(this._onUploadsComplete,this));q.bind(this.wrapper,{load:this.onLoad,select:this.onSelect,upload:this.onUpload,success:this.onSuccess,error:this.onError,complete:this.onComplete,cancel:this.onCancel,remove:this.onRemove});q.trigger(this.wrapper,"load")};q.upload.prototype={enable:function(){this.toggle(true)},disable:function(){this.toggle(false)},toggle:function(t){this.wrapper.toggleClass("t-state-disabled",!t)},_addInput:function(t){t.insertAfter(this.element).data("tUpload",this);n(this.element).hide().removeAttr("id");this._setActiveInput(t)},_setActiveInput:function(t){var u=this.wrapper;this.element=t;t.attr("multiple",this._getSupportsMultiple()?this.multiple:false).attr("autocomplete","off").click(function(v){if(u.hasClass("t-state-disabled")){v.preventDefault()}}).change(n.proxy(this._onInputChange,this))},_onInputChange:function(v){var t=n(v.target),u=q.trigger(this.wrapper,"select",{files:j(t)});if(!u){t.trigger("t:select")}},_enqueueFile:function(x,u){var v=n(".t-upload-files",this.wrapper);if(v.length==0){v=n("<ul class='t-upload-files t-reset'></ul>").appendTo(this.wrapper);if(!this.showFileList){v.hide()}}var t=n(".t-file",v);var w=n("<li class='t-file'><span class='t-icon'></span><span class='t-filename'>"+x+"</span></li>").appendTo(v).data(u);if(!this.multiple){t.trigger("t:remove")}return w},_removeFileEntry:function(u){var t=u.closest(".t-upload-files");if(n(".t-file",t).length==1){t.remove();this._hideUploadButton()}else{u.remove()}},_setFileAction:function(v,t){var u={remove:"t-delete",cancel:"t-cancel"};if(!u.hasOwnProperty(t)){return}this._clearFileAction(v);v.append(this._renderAction(u[t],this.localization[t]).addClass("t-upload-action"))},_setFileState:function(t,v){var w={uploading:{cssClass:"t-loading",text:this.localization.statusUploading},uploaded:{cssClass:"t-success",text:this.localization.statusUploaded},failed:{cssClass:"t-fail",text:this.localization.statusFailed}};var u=w[v];if(u){var x=t.children(".t-icon").text(u.text);x[0].className="t-icon "+u.cssClass}},_renderAction:function(u,t){if(u!=""){return n("<button type='button' class='t-button t-button-icontext'><span class='t-icon "+u+"'></span>"+t+"</button>")}else{return n("<button type='button' class='t-button'>"+t+"</button>")}},_clearFileAction:function(t){t.find(".t-upload-action").remove()},_onFileAction:function(x){if(!this.wrapper.hasClass("t-state-disabled")){var t=n(x.target).closest(".t-upload-action"),w=t.find(".t-icon"),v=t.closest(".t-file"),u={files:v.data("fileNames")};if(w.hasClass("t-delete")){if(!q.trigger(this.wrapper,"remove",u)){v.trigger("t:remove")}}else{if(w.hasClass("t-cancel")){q.trigger(this.wrapper,"cancel",u);v.trigger("t:cancel")}}}return false},_onUploadSelected:function(){this.wrapper.trigger("t:saveSelected");return false},_onFileProgress:function(v,u){var t=n(".t-progress-status",v.target);if(t.length==0){t=n("<span class='t-progress'><span class='t-progress-status' style='width: 0;'></span></span>").appendTo(n(".t-filename",v.target)).find(".t-progress-status")}t.width(u+"%")},_onUploadSuccess:function(w,v,t){var u=n(w.target);this._setFileState(u,"uploaded");q.trigger(this.wrapper,"success",{files:u.data("fileNames"),response:v,operation:"upload",XMLHttpRequest:t});if(this._supportsRemove()){this._setFileAction(u,"remove")}else{this._clearFileAction(u)}},_onUploadError:function(w,t){var v=n(w.target);this._setFileState(v,"failed");this._clearFileAction(v);var u=q.trigger(this.wrapper,"error",{operation:"upload",files:v.data("fileNames"),XMLHttpRequest:t});s("Server response: "+t.responseText);if(!u){this._alert("Error! Upload failed. Unexpected server response - see console.")}},_onUploadsComplete:function(){q.trigger(this.wrapper,"complete")},_showUploadButton:function(){var t=n(".t-upload-selected",this.wrapper);if(t.length==0){t=this._renderAction("",this.localization.uploadSelectedFiles).addClass("t-upload-selected")}this.wrapper.append(t)},_hideUploadButton:function(){n(".t-upload-selected",this.wrapper).remove()},_onParentFormSubmit:function(){this.element.trigger("t:abort");var u=this;if(!this.element.value){var t=n(this.element).attr("name","");setTimeout(function(){t.attr("name",u.name)},0)}},_onParentFormReset:function(){n(".t-file",this.wrapper).trigger("t:remove")},_getSupportsFormData:function(){return typeof(FormData)!="undefined"},_getSupportsMultiple:function(){return !n.browser.opera},_getSupportsDrop:function(){var w=this._getUserAgent().toLowerCase(),u=/chrome/.test(w),t=!u&&/safari/.test(w),v=t&&/windows/.test(w);return !v&&this._getSupportsFormData()},_getUserAgent:function(){return navigator.userAgent},_setupDropZone:function(){n(".t-upload-button",this.wrapper).wrap("<div class='t-dropzone'></div>");var t=n(".t-dropzone",this.wrapper).append(n("<em>"+this.localization.dropFilesHere+"</em>")).bind({dragenter:d,dragover:function(u){u.preventDefault()},drop:n.proxy(this._onDrop,this)});h(t,function(){t.addClass("t-dropzone-hovered")},function(){t.removeClass("t-dropzone-hovered")});h(n(document),function(){t.addClass("t-dropzone-active")},function(){t.removeClass("t-dropzone-active")})},_onDrop:function(v){var t=v.originalEvent.dataTransfer,u=t.files;d(v);if(u.length>0){n(".t-dropzone",this.wrapper).trigger("t:select",[u])}},_supportsRemove:function(){return this.async.removeUrl!=r},_submitRemove:function(v,t,w){var u={};u.fileNames=v;n.ajax({type:"POST",dataType:"json",url:this.async.removeUrl,traditional:true,data:u,success:t,error:w})},_alert:function(t){alert(t)}};n.fn.tUpload=function(t){return q.create(this,{name:"tUpload",init:function(u,v){return new q.upload(u,v)},options:t})};n.fn.tUpload.defaults={enabled:true,multiple:true,showFileList:true,async:{},localization:{cancel:"Cancel",remove:"Remove",uploadSelectedFiles:"Upload files",dropFilesHere:"drop files here to upload",statusUploading:"uploading",statusUploaded:"uploaded",statusFailed:"failed"}};var g=function(t){this.name="syncUploadModule";this.element=t.wrapper;this.upload=t;this.element.bind("t:select",n.proxy(this.onSelect,this)).bind("t:remove",n.proxy(this.onRemove,this)).closest("form").attr("enctype","multipart/form-data").attr("encoding","multipart/form-data")};g.prototype={onSelect:function(w){var t=this.upload;var u=n(w.target);t._addInput(u.clone().val(""));var v=t._enqueueFile(m(u),{relatedInput:u});t._setFileAction(v,"remove")},onRemove:function(u){var t=n(u.target);t.data("relatedInput").remove();this.upload._removeFileEntry(t)}};var f=function(t){this.name="iframeUploadModule";this.element=t.wrapper;this.upload=t;this.iframes=[];this.element.bind("t:select",n.proxy(this.onSelect,this)).bind("t:cancel",n.proxy(this.onCancel,this)).bind("t:remove",n.proxy(this.onRemove,this)).bind("t:saveSelected",n.proxy(this.onSaveSelected,this)).bind("t:abort",n.proxy(this.onAbort,this))};f.prototype={onSelect:function(w){var t=this.upload,u=n(w.target);var v=this.prepareUpload(u);if(t.async.autoUpload){this.performUpload(v)}else{if(t._supportsRemove()){this.upload._setFileAction(v,"remove")}t._showUploadButton()}},prepareUpload:function(y){var w=this.upload;var v=n(w.element);w._addInput(y.clone().val(""));var x=this.createFrame(w.name+"_"+this.iframes.length);this.registerFrame(x);var u=this.createForm(w.async.saveUrl,x.attr("name")).append(v);var t=w._enqueueFile(m(y),{frame:x,relatedInput:v,fileNames:j(y)});x.data({form:u,file:t});return t},performUpload:function(t){var x={files:t.data("fileNames")},w=t.data("frame"),v=this.upload;if(!q.trigger(v.wrapper,"upload",x)){v._hideUploadButton();w.appendTo(document.body);var u=w.data("form").appendTo(document.body);if(x.data){u[0].action+=(/\?/.test(u[0].action)?"&":"?")+n.param(x.data)}v._setFileAction(t,"cancel");v._setFileState(t,"uploading");w.one("load",n.proxy(this.onIframeLoad,this));u[0].submit()}else{v._removeFileEntry(w.data("file"));this.cleanupFrame(w);this.unregisterFrame(w)}},onSaveSelected:function(u){var t=this;n(".t-file",this.element).each(function(){var v=n(this),w=a(v);if(!w){t.performUpload(v)}})},onIframeLoad:function(v){var u=n(v.target),t=u.contents().text();this.processResponse(u,t)},processResponse:function(v,w){var t=v.data("file");var u={responseText:w};i(w,function(x){n.extend(u,{statusText:"OK",status:"200"});t.trigger("t:upload-success",[x,u])},function(){n.extend(u,{statusText:"error",status:"500"});t.trigger("t:upload-error",[u])});this.cleanupFrame(v);this.unregisterFrame(v)},onCancel:function(u){var t=n(u.target).data("frame");this.stopFrameSubmit(t);this.cleanupFrame(t);this.unregisterFrame(t);this.upload._removeFileEntry(t.data("file"))},onRemove:function(v){var t=n(v.target);var u=t.data("frame");if(u){this.unregisterFrame(u);this.upload._removeFileEntry(t);this.cleanupFrame(u)}else{e(t,this.upload)}},onAbort:function(){var t=this.element,u=this;n.each(this.iframes,function(){n("input",this.data("form")).appendTo(t);u.stopFrameSubmit(this[0]);this.data("form").remove();this.remove()});this.iframes=[]},createFrame:function(t){return n("<iframe name='"+t+"' id='"+t+"' style='display:none;' />")},createForm:function(t,u){return n("<form enctype='multipart/form-data' method='POST' action='"+t+"' target='"+u+"'/>")},stopFrameSubmit:function(t){if(typeof(t.stop)!="undefined"){t.stop()}else{if(t.document){t.document.execCommand("Stop");t.contentWindow.location.href=t.contentWindow.location.href}}},registerFrame:function(t){this.iframes.push(t)},unregisterFrame:function(t){this.iframes=n.grep(this.iframes,function(u){return u.attr("name")!=t.attr("name")});if(this.iframes.length==0){n(this.element).trigger("t:uploads-complete")}},cleanupFrame:function(t){var u=t.data("form");t.data("file").data("frame",null);setTimeout(function(){u.remove();t.remove()},1)}};var o=function(t){this.name="formDataUploadModule";this.element=t.wrapper;this.upload=t;this.element.bind("t:select",n.proxy(this.onSelect,this)).bind("t:cancel",n.proxy(this.onCancel,this)).bind("t:remove",n.proxy(this.onRemove,this)).bind("t:saveSelected",n.proxy(this.onSaveSelected,this)).bind("t:abort",n.proxy(this.onAbort,this))};o.prototype={onSelect:function(x,u){var y=this.upload,w=this,z=n(x.target),v=u?c(u):this.getInputFiles(z),t=this.prepareUpload(z,v);n.each(t,function(){if(y.async.autoUpload){w.performUpload(this)}else{if(y._supportsRemove()){y._setFileAction(this,"remove")}y._showUploadButton()}})},prepareUpload:function(t,u){var v=this.enqueueFiles(u);if(t.is("input")){n.each(v,function(){n(this).data("relatedInput",t)});t.data("relatedFileEntries",v);this.upload._addInput(t.clone().val(""))}return v},enqueueFiles:function(w){var y=this.upload;fileEntries=[];for(var t=0;t<w.length;t++){var v=w[t],x=v.name;var u=y._enqueueFile(x,{fileNames:[v]});u.data("formData",this.createFormData(w[t]));fileEntries.push(u)}return fileEntries},getInputFiles:function(t){return j(t)},performUpload:function(x){var t=this.upload,u=x.data("formData"),w={files:x.data("fileNames")};if(!q.trigger(this.element,"upload",w)){t._setFileAction(x,"cancel");t._hideUploadButton();var v=this.upload.async.saveUrl;if(w.data){v+=(/\?/.test(v)?"&":"?")+n.param(w.data)}t._setFileState(x,"uploading");this.postFormData(v,u,x)}else{this.removeFileEntry(x)}},onSaveSelected:function(u){var t=this;n(".t-file",this.element).each(function(){var v=n(this),w=a(v);if(!w){t.performUpload(v)}})},onCancel:function(u){var t=n(u.target).closest(".t-file");this.stopUploadRequest(t);this.removeFileEntry(t)},onRemove:function(v){var t=n(v.target);var u=t.data("formData");if(u){this.upload._removeFileEntry(t)}else{e(t,this.upload)}},postFormData:function(t,u,x){var w=new XMLHttpRequest(),v=this;x.data("request",w);w.addEventListener("load",function(y){v.onRequestSuccess.call(v,y,x)},false);w.addEventListener("error",function(y){v.onRequestError.call(v,y,x)},false);w.upload.addEventListener("progress",function(y){v.onRequestProgress.call(v,y,x)},false);w.open("POST",t);w.send(u)},createFormData:function(t){var u=new FormData();u.append(this.upload.name,t.rawFile);return u},onRequestSuccess:function(v,t){var u=v.target;i(u.responseText,function(w){t.trigger("t:upload-success",[w,u])},function(){t.trigger("t:upload-error",[u])});this.cleanupFileEntry(t);this.checkAllComplete()},onRequestError:function(v,t){var u=v.target;t.trigger("t:upload-error",[u]);this.cleanupFileEntry(t);this.checkAllComplete()},cleanupFileEntry:function(t){var v=t.data("relatedInput"),u=true;if(v){n.each(v.data("relatedFileEntries"),function(){u=u&&n(this).children(".t-icon").is(".t-success, .t-fail")});if(u){v.remove()}}t.data("formData",null)},removeFileEntry:function(t){this.cleanupFileEntry(t);this.upload._removeFileEntry(t)},checkAllComplete:function(){var t=true;n(".t-file",this.wrapper).each(function(){if(n(this).data("formData")!=null){t=false}});if(t){this.element.trigger("t:uploads-complete")}},onRequestProgress:function(v,t){var u=Math.round(v.loaded*100/v.total);t.trigger("t:progress",[u])},stopUploadRequest:function(t){t.data("request").abort()}};function m(t){return n.map(j(t),function(u){return u.name}).join(", ")}function j(u){var t=u[0];if(t.files){return c(t.files)}else{return[{name:l(t.value),extension:p(t.value),size:null}]}}function c(t){return n.map(t,function(u){return b(u)})}function b(t){var u=t.name||t.fileName;return{name:u,extension:p(u),size:t.size||t.fileSize,rawFile:t}}function p(t){return t.match(k)[0]||""}function l(t){var u=t.lastIndexOf("\\");return(u!=-1)?t.substr(u+1):t}function e(u,w){var v=u.data("fileNames");var t=n.map(v,function(z){return z.name});w._submitRemove(t,function y(A,B,z){w._removeFileEntry(u);q.trigger(w.wrapper,"success",{operation:"remove",files:v,response:A,XMLHttpRequest:z})},function x(z,B,B){var A=q.trigger(w.wrapper,"error",{operation:"remove",files:v,XMLHttpRequest:z});s("Server response: "+z.responseText);if(!A){w._alert("Error! Remove operation failed. Unexpected response - see console.")}})}function i(u,t,v){try{var w=n.parseJSON(u);t(w)}catch(x){v()}}function d(t){t.stopPropagation();t.preventDefault()}function h(w,v,x){var u,t;w.bind("dragenter",function(y){v();t=new Date();if(!u){u=setInterval(function(){var z=new Date()-t;if(z>100){x();clearInterval(u);u=null}},100)}}).bind("dragover",function(y){t=new Date()})}function a(t){return t.children(".t-icon").is(".t-loading, .t-success, .t-fail")}function s(t){if(typeof(console)!="undefined"&&console.log){console.log(t)}}})(jQuery);